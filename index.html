<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#4A90E2" />
  <title>ğŸ  å®¶ç”¨ç‰©å“ç®¡å®¶</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
      background: #f9f9f9;
      color: #333;
      line-height: 1.6;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      max-width: 600px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      padding: 16px;
      background: #4A90E2;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .container { padding: 16px; }
    input, select, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }
    textarea { height: 60px; resize: vertical; }
    button {
      background: #4A90E2;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button.secondary { background: #6c757d; }
    button.mini {
      width: auto;
      padding: 6px 12px;
      font-size: 14px;
      margin-left: 8px;
    }
    .item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .location-path {
      color: #666;
      font-size: 14px;
      margin: 6px 0;
    }
    .item img { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; }
    #scannerContainer {
      display: none;
      position: relative;
      height: 300px;
      background: #000;
      border-radius: 12px;
      margin: 16px 0;
      overflow: hidden;
    }
    #barcodeScanner { width: 100%; height: 100%; object-fit: cover; }
    .scan-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border: 2px solid #28a745;
      box-shadow: inset 0 0 0 1000px rgba(0,0,0,0.5);
      pointer-events: none;
    }
    footer { text-align: center; padding: 16px; color: #888; font-size: 14px; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ  å®¶ç”¨ç‰©å“ç®¡å®¶</h1>
  </header>

  <div class="container">
    <!-- æœç´¢ä¸ç­›é€‰ -->
    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ç‰©å“åç§°æˆ–ä½ç½®..." />

    <!-- å¿«é€Ÿå½•å…¥è¡¨å• -->
    <input type="text" id="itemName" placeholder="ç‰©å“åç§°ï¼ˆå¿…å¡«ï¼‰" />
    <input type="text" id="itemCategory" placeholder="åˆ†ç±»ï¼ˆå¦‚ï¼šå¨æˆ¿ç”µå™¨ï¼‰" list="categoryList" />

    <div style="display:flex;align-items:center;">
      <select id="itemRoom" style="flex:1;"></select>
      <button type="button" class="mini" onclick="addNewRoom()">+ æ–°å»º</button>
    </div>

    <div style="display:flex;align-items:center;">
      <select id="itemContainer" style="flex:1;">
        <option value="">å®¹å™¨ï¼ˆå¦‚ï¼šè¡£æŸœã€å·¥å…·ç®±ï¼‰</option>
      </select>
      <button type="button" class="mini" onclick="addNewContainer()">+ æ–°å»º</button>
    </div>

    <input type="text" id="itemShelf" placeholder="å±‚/æ ¼ï¼ˆå¦‚ï¼šä¸Šå±‚ã€ç¬¬äºŒæ ¼ï¼‰" list="shelfList" />
    <textarea id="itemLocation" placeholder="å…·ä½“ä½ç½®æè¿°ï¼ˆå¦‚ï¼šå·¦ä¸Šè§’æŠ½å±‰å†…ï¼‰"></textarea>

    <input type="file" id="itemImage" accept="image/*" capture="environment" />
    <input type="file" id="itemQrCode" accept="image/*" placeholder="å¯é€‰ï¼šä¸Šä¼ äºŒç»´ç æ ‡ç­¾" />

    <button id="addItem">â• æ·»åŠ ç‰©å“</button>

    <!-- åŠŸèƒ½æŒ‰é’® -->
    <div style="display:flex;gap:8px;margin:16px 0;flex-wrap:wrap;">
      <button id="exportBtn" class="secondary">ğŸ“¤ å¯¼å‡ºåˆ° iCloud</button>
      <button id="importBtn" class="secondary">ğŸ“¥ ä» iCloud å¯¼å…¥</button>
      <button id="scanBtn" class="secondary" style="display:none;">ğŸ“· æ‰«ææ¡ç </button>
    </div>

    <!-- æ‰«ç åŒºåŸŸ -->
    <div id="scannerContainer">
      <video id="barcodeScanner" autoplay playsinline></video>
      <div class="scan-overlay"></div>
    </div>

    <hr style="margin:20px 0;border:none;border-top:1px solid #eee;" />

    <!-- ç‰©å“åˆ—è¡¨ -->
    <div id="itemsList"></div>
  </div>

  <!-- datalist for suggestions -->
  <datalist id="categoryList"></datalist>
  <datalist id="shelfList"></datalist>

  <footer>
    æ•°æ®ä¿å­˜åœ¨æœ¬æœº Â· å¯¼å‡º JSON åˆ° iCloud Drive å¯è·¨è®¾å¤‡åŒæ­¥
  </footer>

  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/zxing-browser.min.js"></script>
  <script>
    // ======================
    // æ•°æ®å­˜å‚¨ç»“æ„
    // ======================
    let items = JSON.parse(localStorage.getItem('homeItems_v2') || '[]');
    let recentRooms = JSON.parse(localStorage.getItem('recentRooms') || '["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"]');
    let recentContainers = JSON.parse(localStorage.getItem('recentContainers') || '["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"]');
    let recentShelves = JSON.parse(localStorage.getItem('recentShelves') || '["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"]');

    // ======================
    // DOM å…ƒç´ 
    // ======================
    const itemsList = document.getElementById('itemsList');
    const searchInput = document.getElementById('searchInput');
    const itemName = document.getElementById('itemName');
    const itemCategory = document.getElementById('itemCategory');
    const itemRoom = document.getElementById('itemRoom');
    const itemContainer = document.getElementById('itemContainer');
    const itemShelf = document.getElementById('itemShelf');
    const itemLocation = document.getElementById('itemLocation');
    const itemImage = document.getElementById('itemImage');
    const itemQrCode = document.getElementById('itemQrCode');
    const addItemBtn = document.getElementById('addItem');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const scanBtn = document.getElementById('scanBtn');
    const scannerContainer = document.getElementById('scannerContainer');
    const video = document.getElementById('barcodeScanner');
    const categoryList = document.getElementById('categoryList');
    const shelfList = document.getElementById('shelfList');

    // ======================
    // å·¥å…·å‡½æ•°
    // ======================
    function uuid() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    function saveData() {
      localStorage.setItem('homeItems_v2', JSON.stringify(items));
      localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
      localStorage.setItem('recentContainers', JSON.stringify(recentContainers));
      localStorage.setItem('recentShelves', JSON.stringify(recentShelves));
      renderFormOptions();
      renderItems();
    }

    function getLocationPath(item) {
      let path = item.room;
      if (item.container) path += ` > ${item.container}`;
      if (item.shelf_or_compartment) path += ` > ${item.shelf_or_compartment}`;
      return path;
    }

    // ======================
    // æ¸²æŸ“è¡¨å•é€‰é¡¹
    // ======================
    function renderFormOptions() {
      // æˆ¿é—´ä¸‹æ‹‰
      itemRoom.innerHTML = '';
      recentRooms.forEach(room => {
        const opt = document.createElement('option');
        opt.value = room;
        opt.textContent = room;
        itemRoom.appendChild(opt);
      });

      // å®¹å™¨ä¸‹æ‹‰
      const containerOpts = recentContainers.map(c => `<option value="${c}">${c}</option>`).join('');
      itemContainer.innerHTML = `<option value="">å®¹å™¨ï¼ˆå¦‚ï¼šè¡£æŸœã€å·¥å…·ç®±ï¼‰</option>${containerOpts}`;

      // datalist
      categoryList.innerHTML = '';
      const categories = [...new Set(items.map(i => i.category).filter(Boolean))];
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        categoryList.appendChild(opt);
      });

      shelfList.innerHTML = '';
      recentShelves.forEach(shelf => {
        const opt = document.createElement('option');
        opt.value = shelf;
        shelfList.appendChild(opt);
      });
    }

    // ======================
    // æ¸²æŸ“ç‰©å“åˆ—è¡¨
    // ======================
    function renderItems() {
      const term = searchInput.value.trim().toLowerCase();
      const filtered = items.filter(item =>
        item.name.toLowerCase().includes(term) ||
        getLocationPath(item).toLowerCase().includes(term) ||
        (item.specific_location && item.specific_location.toLowerCase().includes(term))
      );

      itemsList.innerHTML = filtered.length === 0
        ? '<p style="text-align:center;color:#888;">æš‚æ— ç‰©å“</p>'
        : filtered.map(item => `
          <div class="item">
            <strong>${item.name}</strong>
            ${item.category ? `<br><small>ğŸ“‚ ${item.category}</small>` : ''}
            <div class="location-path">${getLocationPath(item)}</div>
            ${item.specific_location ? `<div>${item.specific_location}</div>` : ''}
            ${item.image ? `<img src="${item.image}" alt="${item.name}">` : ''}
            ${item.qr_code ? `<img src="${item.qr_code}" alt="QR" style="width:80px;height:80px;margin-top:8px;">` : ''}
            <button class="secondary" style="margin-top:10px;" onclick="deleteItem('${item.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
          </div>
        `).join('');

      // è‡ªåŠ¨é€‰ä¸­ä¸Šæ¬¡ä½¿ç”¨çš„æˆ¿é—´ï¼ˆæå‡ä½“éªŒï¼‰
      if (items.length > 0) {
        const lastRoom = items[items.length - 1].room;
        itemRoom.value = lastRoom;
      }
    }

    // ======================
    // äº‹ä»¶å¤„ç†
    // ======================
    addItemBtn.addEventListener('click', () => {
      const name = itemName.value.trim();
      const room = itemRoom.value.trim();
      if (!name || !room) {
        alert('è¯·å¡«å†™ç‰©å“åç§°å’Œæˆ¿é—´');
        return;
      }

      // æ”¶é›†æ•°æ®
      const newItem = {
        id: uuid(),
        name,
        category: itemCategory.value.trim(),
        room,
        container: itemContainer.value.trim() || null,
        shelf_or_compartment: itemShelf.value.trim() || null,
        specific_location: itemLocation.value.trim() || null,
        image: '',
        qr_code: ''
      };

      // å¤„ç†å›¾ç‰‡
      const promises = [];
      if (itemImage.files[0]) {
        promises.push(new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = e => {
            newItem.image = e.target.result;
            resolve();
          };
          reader.readAsDataURL(itemImage.files[0]);
        }));
      }
      if (itemQrCode.files[0]) {
        promises.push(new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = e => {
            newItem.qr_code = e.target.result;
            resolve();
          };
          reader.readAsDataURL(itemQrCode.files[0]);
        }));
      }

      Promise.all(promises).then(() => {
        // æ›´æ–°æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
        if (!recentRooms.includes(newItem.room)) recentRooms.unshift(newItem.room);
        if (newItem.container && !recentContainers.includes(newItem.container)) recentContainers.unshift(newItem.container);
        if (newItem.shelf_or_compartment && !recentShelves.includes(newItem.shelf_or_compartment)) recentShelves.unshift(newItem.shelf_or_compartment);

        // é™åˆ¶é•¿åº¦
        recentRooms = recentRooms.slice(0, 20);
        recentContainers = recentContainers.slice(0, 20);
        recentShelves = recentShelves.slice(0, 20);

        items.push(newItem);
        saveData();
        resetForm();
      });
    });

    function deleteItem(id) {
      if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
        items = items.filter(item => item.id !== id);
        saveData();
      }
    }

    function addNewRoom() {
      const newRoom = prompt('è¯·è¾“å…¥æ–°æˆ¿é—´åç§°ï¼š');
      if (newRoom && newRoom.trim() && !recentRooms.includes(newRoom.trim())) {
        recentRooms.unshift(newRoom.trim());
        saveData();
      }
    }

    function addNewContainer() {
      const newContainer = prompt('è¯·è¾“å…¥æ–°å®¹å™¨åç§°ï¼š');
      if (newContainer && newContainer.trim() && !recentContainers.includes(newContainer.trim())) {
        recentContainers.unshift(newContainer.trim());
        saveData();
      }
    }

    // å¯¼å‡º
    exportBtn.addEventListener('click', () => {
      if (items.length === 0) return alert('æ²¡æœ‰ç‰©å“å¯å¯¼å‡º');
      const blob = new Blob([JSON.stringify({ items, recentRooms, recentContainers, recentShelves }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `HomeItems_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('âœ… å¯¼å‡ºæˆåŠŸï¼\nè¯·ä¿å­˜åˆ° iCloud Drive ä»¥è·¨è®¾å¤‡åŒæ­¥ã€‚');
      }, 100);
    });

    // å¯¼å…¥
    let importFile = document.createElement('input');
    importFile.type = 'file';
    importFile.accept = '.json';
    importFile.style.display = 'none';
    importFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data.items) throw new Error('æ ¼å¼é”™è¯¯');
          if (!confirm(`å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼ˆå…± ${data.items.length} é¡¹ï¼‰ï¼Œç¡®å®šå¯¼å…¥ï¼Ÿ`)) return;
          
          items = data.items;
          recentRooms = data.recentRooms || recentRooms;
          recentContainers = data.recentContainers || recentContainers;
          recentShelves = data.recentShelves || recentShelves;
          saveData();
          alert('å¯¼å…¥æˆåŠŸï¼');
        } catch (err) {
          alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
        }
      };
      reader.readAsText(file);
      importFile.value = '';
    });
    document.body.appendChild(importFile);
    importBtn.addEventListener('click', () => importFile.click());

    // æ¡ç æ‰«æ
    async function initScanner() {
      if (location.protocol !== 'https:') return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        scanBtn.style.display = 'block';
      } catch (e) {}
    }
    initScanner();

    let codeReader = null;
    scanBtn.addEventListener('click', () => {
      if (scannerContainer.style.display === 'block') {
        if (codeReader) codeReader.reset();
        scannerContainer.style.display = 'none';
        scanBtn.textContent = 'ğŸ“· æ‰«ææ¡ç ';
        return;
      }
      scannerContainer.style.display = 'block';
      scanBtn.textContent = 'â¹ åœæ­¢æ‰«æ';
      codeReader = new ZXing.BrowserMultiFormatReader();
      codeReader.decodeFromVideoDevice(undefined, 'barcodeScanner', (result, err) => {
        if (result) {
          itemName.value = result.getText();
          if (codeReader) codeReader.reset();
          scannerContainer.style.display = 'none';
          scanBtn.textContent = 'ğŸ“· æ‰«ææ¡ç ';
        }
      });
    });

    // æœç´¢å®æ—¶è¿‡æ»¤
    searchInput.addEventListener('input', renderItems);

    // åˆå§‹åŒ–
    renderFormOptions();
    renderItems();

    function resetForm() {
      itemName.value = '';
      itemCategory.value = '';
      itemShelf.value = '';
      itemLocation.value = '';
      itemImage.value = '';
      itemQrCode.value = '';
      itemName.focus();
    }

    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>
